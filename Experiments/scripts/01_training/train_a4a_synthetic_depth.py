"""
Eksperimen A.4a: Synthetic Depth Only

Train YOLOv11n on synthetic depth generated by Depth-Anything-V2.
This experiment tests whether synthetic depth can replace real depth sensors.

Usage:
    python train_a4a_synthetic_depth.py

Requirements:
    - Synthetic depth dataset prepared (run prepare_synthetic_depth_data.py first)
    - ultralytics>=8.3.0

Comparison:
    - A.2: Real depth (RealSense sensor)
    - A.4a: Synthetic depth (Depth-Anything-V2)

Author: Research Team
Date: 2026-01-21
"""

import os
import subprocess
from pathlib import Path

import yaml

CONFIG_DIR = Path(r"D:\Work\Assisten Dosen\Anylabel\Experiments")

BASE_CONFIG = {
    "task": "detect",
    "mode": "train",
    "model": "yolo11n.pt",
    "data": "configs/ffb_localization_depth_synthetic.yaml",
    "epochs": 50,
    "patience": 10,
    "batch": 16,
    "imgsz": 640,
    "save": True,
    "device": 0,
    "workers": 4,
    "project": "runs/detect",
    "name": "exp_a4a_synthetic_depth",
}

SEEDS = [42, 123]


def train_with_seed(seed):
    """
    Train with specific seed.

    Args:
        seed (int): Random seed for reproducibility

    Returns:
        bool: True if training successful
    """
    config = BASE_CONFIG.copy()
    config["seed"] = seed
    config["name"] = f"exp_a4a_synthetic_depth_seed_{seed}"

    config_filename = f"config_a4a_synthetic_depth_seed_{seed}.yaml"
    config_path = CONFIG_DIR / config_filename

    with open(config_path, "w") as f:
        yaml.dump(config, f, default_flow_style=False)

    print(f"\n{'=' * 60}")
    print(f"TRAINING A.4a SYNTHETIC DEPTH - Seed {seed}")
    print(f"{'=' * 60}")
    print(f"Config: {config_path}")
    print(f"Output: runs/detect/{config['name']}")
    print(f"{'=' * 60}\n")

    command = f"cd {CONFIG_DIR} && yolo detect train config={config_filename}"

    try:
        subprocess.run(command, shell=True, check=True)
        print(f"\n✓ Training completed for seed {seed}")
        return True
    except subprocess.CalledProcessError as e:
        print(f"\n✗ Training failed for seed {seed}: {e}")
        return False


def main():
    print("=" * 60)
    print("Eksperimen A.4a: Synthetic Depth Only")
    print("=" * 60)

    # Check if dataset exists
    dataset_path = CONFIG_DIR / "datasets" / "ffb_localization_depth_synthetic"
    config_path = CONFIG_DIR / "configs" / "ffb_localization_depth_synthetic.yaml"

    if not dataset_path.exists():
        print(f"\n✗ Synthetic depth dataset not found: {dataset_path}")
        print("\nPlease run:")
        print("  1. python generate_synthetic_depth.py")
        print("  2. python prepare_synthetic_depth_data.py")
        return

    if not config_path.exists():
        print(f"\n✗ Config file not found: {config_path}")
        print("\nPlease run:")
        print("  python prepare_synthetic_depth_data.py")
        return

    print(f"\n✓ Dataset found: {dataset_path}")
    print(f"✓ Config found: {config_path}")

    # Train with both seeds
    print("\n" + "=" * 60)
    print("Training")
    print("=" * 60)

    results = []
    for seed in SEEDS:
        success = train_with_seed(seed)
        results.append((seed, success))

    # Summary
    print("\n" + "=" * 60)
    print("TRAINING SUMMARY")
    print("=" * 60)

    for seed, success in results:
        status = "✓ SUCCESS" if success else "✗ FAILED"
        print(f"Seed {seed}: {status}")

    print("\nResults location:")
    for seed in SEEDS:
        print(f"  - Seed {seed}: runs/detect/exp_a4a_synthetic_depth_seed_{seed}/")

    print("\nEvaluation:")
    print("  cd Experiments")
    print(
        "  yolo detect val model=runs/detect/exp_a4a_synthetic_depth_seed_42/weights/best.pt \\"
    )
    print(
        "                  data=configs/ffb_localization_depth_synthetic.yaml split=test"
    )

    print("\nComparison with A.2 (real depth):")
    print("  - A.2 uses real depth from RealSense sensor")
    print("  - A.4a uses synthetic depth from Depth-Anything-V2")
    print("  - Compare mAP50-95 to assess synthetic depth quality")


if __name__ == "__main__":
    main()
