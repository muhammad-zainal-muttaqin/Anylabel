"""
Eksperimen A.4b: RGB + Synthetic Depth (4-channel)

Train YOLOv11n with RGB + synthetic depth generated by Depth-Anything-V2.
Similar to A.3, but uses synthetic depth instead of real depth sensor data.

Usage:
    python train_a4b_rgbd_synthetic.py

Requirements:
    - Synthetic depth generated (run generate_synthetic_depth.py first)
    - Modified 4-channel model (yolo11n_4ch.pt from train_a3_rgbd.py)
    - custom_rgbd_dataset.py

Comparison:
    - A.3: RGB + Real Depth
    - A.4b: RGB + Synthetic Depth

Author: Research Team
Date: 2026-01-21
"""

import os
import subprocess
from pathlib import Path

import yaml

CONFIG_DIR = Path(r"D:\Work\Assisten Dosen\Anylabel\Experiments")

BASE_CONFIG = {
    "task": "detect",
    "mode": "train",
    "model": "yolo11n_4ch.pt",  # Modified 4-channel model
    "data": "configs/ffb_localization_rgbd_synthetic.yaml",
    "epochs": 50,
    "patience": 10,
    "batch": 16,
    "imgsz": 640,
    "save": True,
    "device": 0,
    "workers": 4,
    "project": "runs/detect",
}

SEEDS = [42, 123]


def train_with_seed(seed):
    """
    Train with specific seed.

    Args:
        seed (int): Random seed for reproducibility

    Returns:
        bool: True if training successful
    """
    config = BASE_CONFIG.copy()
    config["seed"] = seed
    config["name"] = f"exp_a4b_rgbd_synthetic_seed_{seed}"

    # Use default YOLO augmentation (same as A.3 Option A)
    config["hsv_h"] = 0.015
    config["hsv_s"] = 0.7
    config["hsv_v"] = 0.4

    config_filename = f"config_a4b_rgbd_synthetic_seed_{seed}.yaml"
    config_path = CONFIG_DIR / config_filename

    with open(config_path, "w") as f:
        yaml.dump(config, f, default_flow_style=False)

    print(f"\n{'=' * 60}")
    print(f"TRAINING A.4b RGB+SYNTHETIC DEPTH - Seed {seed}")
    print(f"{'=' * 60}")
    print(f"Config: {config_path}")
    print(f"Output: runs/detect/{config['name']}")
    print(f"{'=' * 60}\n")

    print("NOTE: For actual training:")
    print("  - Use custom_rgbd_dataset.py with synthetic depth directory")
    print("  - Or train on Kaggle with custom dataset implementation")
    print(f"  Config saved: {config_path}")

    return True


def create_config_yaml():
    """Create YAML config for A.4b dataset."""
    yaml_content = f"""# Dataset Configuration for A.4b - RGB + Synthetic Depth (4-channel)
path: D:/Work/Assisten Dosen/Anylabel/Experiments/datasets/ffb_localization
depth_dir: D:/Work/Assisten Dosen/Anylabel/Experiments/datasets/depth_synthetic_da2

train: images/train
val: images/val
test: images/test

nc: 1
names: ['fresh_fruit_bunch']

# Note: Uses synthetic depth from Depth-Anything-V2
# Compare with A.3 (real depth) to assess synthetic depth quality
"""

    yaml_path = CONFIG_DIR / "configs" / "ffb_localization_rgbd_synthetic.yaml"
    yaml_path.write_text(yaml_content)
    print(f"Config created: {yaml_path}")
    return yaml_path


def main():
    print("=" * 60)
    print("Eksperimen A.4b: RGB + Synthetic Depth (4-channel)")
    print("=" * 60)

    # Check if modified model exists
    modified_model = CONFIG_DIR / "yolo11n_4ch.pt"
    if not modified_model.exists():
        print(f"\n✗ Modified 4-channel model not found: {modified_model}")
        print("\nPlease run first:")
        print("  python train_a3_rgbd.py  # This creates yolo11n_4ch.pt")
        return

    print(f"\n✓ Modified model found: {modified_model}")

    # Check if synthetic depth exists
    synthetic_depth = CONFIG_DIR / "datasets" / "depth_synthetic_da2"
    if not synthetic_depth.exists():
        print(f"\n✗ Synthetic depth not found: {synthetic_depth}")
        print("\nPlease run first:")
        print("  python generate_synthetic_depth.py")
        return

    print(f"✓ Synthetic depth found: {synthetic_depth}")

    # Create config
    print("\n" + "-" * 60)
    config_yaml = create_config_yaml()
    print(f"✓ Config created: {config_yaml}")

    # Train with both seeds
    print("\n" + "=" * 60)
    print("Training Setup")
    print("=" * 60)

    for seed in SEEDS:
        train_with_seed(seed)

    print("\n" + "=" * 60)
    print("A.4b Training Setup Complete!")
    print("=" * 60)
    print("\nFiles created:")
    print(f"  - {config_yaml}")
    print("  - config_a4b_rgbd_synthetic_seed_*.yaml")

    print("\nFor Kaggle training:")
    print("  1. Upload RGB dataset + synthetic depth")
    print("  2. Upload yolo11n_4ch.pt")
    print("  3. Use custom RGBD dataset (from custom_rgbd_dataset.py)")
    print("  4. Train with configs generated above")

    print("\nComparison:")
    print("  - A.3: RGB + Real Depth → mAP50-95 = ?")
    print("  - A.4a: Synthetic Depth Only → mAP50-95 = ?")
    print("  - A.4b: RGB + Synthetic Depth → mAP50-95 = ?")
    print("  Expected: A.3 > A.4b > A.4a (if synthetic depth quality is good)")


if __name__ == "__main__":
    main()
