"""
Build Kaggle-Uploadable Synthetic Depth Dataset for A.4a

Package synthetic depth dataset into ZIP file for Kaggle upload.
Similar to build_uploadkaggle_depth_only.py but for synthetic depth.

Usage:
    python build_uploadkaggle_synthetic_depth.py

Output:
    - Experiments/UploadKaggle/ffb_localization_depth_synthetic/
    - Experiments/UploadKaggle/ffb_localization_depth_synthetic.zip

Author: Research Team
Date: 2026-01-21
"""

import shutil
from pathlib import Path

PROJECT_DIR = Path(__file__).resolve().parents[2]
DATASET_DIR = PROJECT_DIR / "Experiments" / "datasets"
UPLOADKAGGLE_DIR = PROJECT_DIR / "Experiments" / "UploadKaggle"

SYNTHETIC_DEPTH_SOURCE = DATASET_DIR / "ffb_localization_depth_synthetic"
OUTPUT_DIR = UPLOADKAGGLE_DIR / "ffb_localization_depth_synthetic"

SPLITS = ("train", "val", "test")


def ensure_dirs(out_root):
    """Create directory structure."""
    for split in SPLITS:
        (out_root / "images" / split).mkdir(parents=True, exist_ok=True)
        (out_root / "labels" / split).mkdir(parents=True, exist_ok=True)


def write_yaml(out_root):
    """Write Kaggle-compatible YAML config."""
    yaml_content = """# Dataset Configuration for Synthetic Depth (Kaggle)
# Generated by build_uploadkaggle_synthetic_depth.py

path: /kaggle/input/ffb-localization-depth-synthetic
train: images/train
val: images/val
test: images/test

nc: 1
names: ['fresh_fruit_bunch']

# Note: Synthetic depth generated by Depth-Anything-V2-Large
"""

    yaml_path = out_root / "ffb_localization_depth_synthetic.yaml"
    yaml_path.write_text(yaml_content)
    print(f"YAML created: {yaml_path}")


def build_split(split, source_dir, out_root):
    """
    Copy images and labels for one split.

    Args:
        split: Split name (train/val/test)
        source_dir: Source dataset directory
        out_root: Output directory

    Returns:
        tuple: (images_copied, labels_copied)
    """
    source_images = source_dir / "images" / split
    source_labels = source_dir / "labels" / split

    dest_images = out_root / "images" / split
    dest_labels = out_root / "labels" / split

    if not source_images.exists() or not source_labels.exists():
        print(f"  Warning: {split} source not found")
        return 0, 0

    # Copy images
    image_count = 0
    for img_file in source_images.glob("*.png"):
        shutil.copy2(img_file, dest_images / img_file.name)
        image_count += 1

    # Copy labels
    label_count = 0
    for label_file in source_labels.glob("*.txt"):
        shutil.copy2(label_file, dest_labels / label_file.name)
        label_count += 1

    print(f"  {split}: {image_count} images, {label_count} labels")

    return image_count, label_count


def main():
    print("=" * 60)
    print("Build Kaggle Dataset: Synthetic Depth (A.4a)")
    print("=" * 60)

    # Check if source exists
    if not SYNTHETIC_DEPTH_SOURCE.exists():
        print(f"\n✗ Source dataset not found: {SYNTHETIC_DEPTH_SOURCE}")
        print("\nPlease run:")
        print("  1. python generate_synthetic_depth.py")
        print("  2. python prepare_synthetic_depth_data.py")
        return

    print(f"\n✓ Source: {SYNTHETIC_DEPTH_SOURCE}")
    print(f"✓ Output: {OUTPUT_DIR}")

    # Create directories
    print("\nCreating directory structure...")
    ensure_dirs(OUTPUT_DIR)

    # Write YAML
    print("\nWriting YAML config...")
    write_yaml(OUTPUT_DIR)

    # Build splits
    print("\nCopying files...")
    total_images = 0
    total_labels = 0

    for split in SPLITS:
        images, labels = build_split(split, SYNTHETIC_DEPTH_SOURCE, OUTPUT_DIR)
        total_images += images
        total_labels += labels

    # Create ZIP
    print("\nCreating ZIP archive...")
    zip_base = str(OUTPUT_DIR)
    archive_path = shutil.make_archive(zip_base, "zip", root_dir=OUTPUT_DIR)

    # Get file size
    archive_size = Path(archive_path).stat().st_size / (1024 * 1024)  # MB

    # Summary
    print("\n" + "=" * 60)
    print("Dataset Package Complete!")
    print("=" * 60)
    print(f"\nOutput directory: {OUTPUT_DIR}")
    print(f"ZIP file: {archive_path}")
    print(f"ZIP size: {archive_size:.2f} MB")
    print(f"\nTotal images: {total_images}")
    print(f"Total labels: {total_labels}")

    if total_images != total_labels:
        print("\n⚠️  Warning: Image and label counts don't match!")
    else:
        print("\n✓ Image/label counts match")

    print("\nNext steps:")
    print("  1. Upload ZIP to Kaggle Datasets")
    print("  2. Use in Kaggle notebook for A.4a training")
    print("  3. Compare with A.2 (real depth) results")


if __name__ == "__main__":
    main()
